<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<!-- 
== OpenJSCAD.org, written by Rene K. Mueller <spiritdude@gmail.com>, Licensed under MIT License ==
   with some code from OpenJsCad processfile.html by Joost Nieuwenhuijse 
   in conjunction with csg.js, openjscad.js, lightgl.js by various authors (see them listed in the individual files)

Purpose: 
   More modern interface for OpenJsCad as published at http://joostn.github.com/OpenJsCad/

History:
- 2015/01/07: 0.019: various pull requests from github merged again
- 2014/10/05: 0.018: various pull requests from github merged
- 2013/04/11: 0.017: alpha channel supported in color() and .setColor()
- 2013/04/07: 0.016: csg.js: solidFromSlices() and .setColor() on polygon level, and examples by Eduard Bespalov
- 2013/04/05: 0.015: rudimentary AMF export and import, web and cli
- 2013/04/03: 0.014: multiple files via drag'n'drop, developing locally
- 2013/04/01: 0.013: include() on web-online & drag'n'drop (but not off-line) and cli (server-side)
- 2013/03/20: 0.012: improved UI (slider from the left)
- 2013/03/28: 0.011: rectangular_extrude(), rotate_extrude() added, and torus()
- 2013/03/22: 0.010: leave .scad file intact, and translate on-the-fly
- 2013/03/20: 0.009: OpenSCAD .scad (via openscad-openjscad-translator) and .stl experimental import support integrated
- 2013/03/15: 0.008: minor changes, parameter window smaller, css changes
- 2013/03/14: 0.007: including jQuery to make UI changes easier, e.g. hint window moveable now
- 2013/03/11: 0.005: resize of browser fixed by fixing canvas size to full screen, and avoid scrollbars
- 2013/03/10: 0.001: first version, integrating ACE editor, for now pulled from 3rd party web-site

Todo:
- saving source code edited in ACE locally, perhaps 'SaveAs' (.JSCAD, .STL, .AMF)
- DONE: include(); support of multiple files, see http://jsfiddle.net/yybRu/
-->
<title>Ingegno.be - Lasercut Box Maker</title>
<link rel="shortcut icon" href="imgs/favicon.png" type="image/x-png">
<link rel="stylesheet" href="jquery/themes/base/jquery-ui.css" />
<script src="jquery/jquery-1.9.1.js"></script>
<script src="jquery/jquery-ui.js"></script>
<script src="jquery/jquery.hammer.js"></script>
<link rel="stylesheet" href="style.css" type="text/css">
<link rel="stylesheet" href="openjscad.css" type="text/css">
</head>
<body onload="onload()">
<style>
/* we choose chrome theme for ace, and make sure line number is transparent too */
/* this has to stay in the body (not head) otherwise does not take effect */
.ace-chrome .ace_gutter { 
   border-left: 2px dashed rgba(200,200,200,0.2);
   background: none;
}
.ace-chrome {
   font-size: 10pt;     // -- not 'px', but 'pt' for high dpi screens
}
</style>
<script src="lightgl.js"></script>
<script src="csg.js"></script>
<script src="openjscad.js"></script>
<script src="openscad.js"></script>
<script src="underscore.js"></script>
<script src="openscad-openjscad-translator.js"></script>
<script lang=JavaScript>
var version = '0.019 (2015/01/07)';
//$(function() { $("#parametersdiv").draggable(); }); // doesn't work well, disabled
var me = document.location.toString().match(/^file:/)?'web-offline':'web-online'; // me: {cli, web-offline, web-online}
var browser = 'unknown';
if(navigator.userAgent.match(/(opera|chrome|safari|firefox|msie)/i))
   browser = RegExp.$1.toLowerCase();

$(document).ready(function() {
   $("#menu").height($(window).height());       // initial height
   $("#viewer").height($(window).height());

   $(window).resize(function() {                // adjust the relevant divs
      $("#menu").height($(window).height());
      $("#menuHandle").css({top: '45%'});
      $("#viewer").width($(window).width());
      $("#viewer").height($(window).height());
   });
   setTimeout( function(){$('#menu').css('left','-280px');},3000); // -- hide slide-menu after 3secs

   $('#menu').mouseleave(function() {
      $('#examples').css('height',0); $('#examples').hide(); 
      $('#options').css('height',0); $('#options').hide(); 
   });

   // -- Examples
   $('#examplesTitle').click(function() {
      $('#examples').css('height','auto'); 
      $('#examples').show(); 
      $('#options').css('height',0); $('#options').hide(); 
   });
   $('#examples').mouseleave(function() {
      $('#examples').css('height',0); $('#examples').hide(); 
   });

   // -- Options 
   $('#optionsTitle').click(function() {
      $('#options').css('height','auto'); $('#options').show(); 
      $('#examples').css('height',0); $('#examples').hide(); 
   });
   $('#options').mouseleave(function() {
      $('#options').css('height',0); $('#options').hide(); 
   });
   getOptions();

   //$('#optionsForm').submit(function() {
   //   // save to cookie
   //   $('#optionsForm').hide();
   //   return false;
   //});
   $('#optionsForm').change(function() {
      // save to cookie
      saveOptions();
   });
   
   $('#plate').change(function() {
      if($('#plate').val()=='custom') {
         $('#customPlate').show();
      } else {
         $('#customPlate').hide();
      }
   });
});   
</script>
<div id="header">
<img src="imgs/title.png">
<div id="errordiv"></div>
</div>

<div id=menu>
<img id=menuHandle src="imgs/menuHandleVL.png">
<nav>
<div id=menuVersion>Version <script>document.write(version);</script></div>
<p/>
<table class=info>
<tr><td align=right class=infoOperation>Render Code</td><td class=infoKey>SHIFT + RETURN</td></tr>
<tr><td align=right class=infoOperation>Rotate XZ</td><td class=infoKey>Left Mouse</td></tr>
<tr><td align=right class=infoOperation>Pan</td><td class=infoKey>Middle Mouse or SHIFT + Left Mouse</td></tr>
<tr><td align=right class=infoOperation>Rotate XY</td><td class=infoKey>Right Mouse or ALT + Left Mouse</td></tr>
<tr><td align=right class=infoOperation>Zoom In/Out</td><td class=infoKey>Wheel Mouse or CTRL + Left Mouse</td></tr>
</table>
<table class=info>
<tr><td class=infoKey>
Variant op BoxMaker: maak een doos om te lasercutten naar wens. Stel afmetingen van je doos in en een gewenste richtgrootte voor de tanden. Elke laser of CNC snijdt een stuk materiaal weg. Om  je doos netjes te laten aansluiten geef je bij <b>breedte laserstraal</b> in hoeveel materiaal weggesneden wordt. Alle afmetingen zijn in mm!
</td></tr>
<tr><td class=infoKey>
Om te lasercutten, Kies als Layout <b>Lasercut plaat</b>, genereer de dxf en download deze. Je kan de dxf openen in <a class=navlink href="https://inkscape.org/en/" target=_blank>Inkscape</a>, en opslaan in het formaat nodig voor je lasercutter (pdf, svg, ...). Wil je de doos 3D printen, kies <b>3D print plaat</b>, genereer de STL, en download deze om een 3D print mee te maken.
</td></tr>
</table>
<p>Door <a class=navlink href="https://ingegno.be" target=_blank>Ingegno.be <img src="imgs/externalLink.png" style=externalLink></a>
<br/>
<span class=menuSubInfo>Ingegno werkt met kinderen en jongeren rond creativiteit en maken. Kinderen werken aan technische projecten en leren spelenderwijs robotica, 3D-ontwerp, elektriciteit, laser snijden, 3D printen, enzovoort. </span></p>
<p><a class=navlink href="http://decreatievestem.be/voor-jongeren/makerkids-club/" rel="publisher" target=_blank>VZW De Creatieve STEM <img src="imgs/externalLink.png" style=externalLink></a>
<br/>
<span class=menuSubInfo>Kom naar een van de vrije inloopmomenten van onze makerspace voor kinderen, en maak zelf iets op onze 3D printer of lasercutter met deze apps, of via andere apps. </span>
<p/>
<!--<div id=optionsTitle class=navlink><a href='#' onclick='return false'>Options</a></div>
<div id=options>...</div>
<span class=menuSubInfo>Your personal settings</span></p>
<p/>-->
<b>Andere toffe apps</b>
<table class=info>
    <tr>
        <td align=right><b>Lithophane</b></td>
        <td><a target=_blank href="http://ingegno.be/Manuals/lithophane/">Maak een Lithophane</a> Voor 3D printer.</td>
    </tr>
    <tr>
        <td align=right><b>Stempels</b></td>
        <td><a target=_blank href="http://chaaawa.com/stamp_factory/">Je eigen stempels maken</a>  Voor 3D printer.</td>
    </tr>
    <tr>
        <td align=right><b>Kaarsen</b></td>
        <td><a target=_blank href="http://3km.ch/candlecaster/">Je eigen kaarsvormen maken</a> Of gebruik het als koekjessnijder! </td> 
    </tr>
    <tr>
        <td align=right><b>3D Ontwerpen</b></td><td><a target=_blank href="http://openjscad.org/">OpenJSCAD.org</a> Zelf 3D figuren programmeren. Voor gevorderden.</td></tr>
</table>
<p><a class=navlink href="#" onclick="$('#about').show(); return false;">About</a></p>
</nav>
</div> <!-- /menu -->

<div id=about>
<img src="imgs/title.png"><br>
Version <script>document.write(version);</script>
<p>
by Ren&eacute; K. M&uuml;ller (UI & CLI),
Joost Nieuwenhuijse (core), 
Eduard Bespalov (core),
Gary Hogdson (OpenSCAD translator)
<p>csg.js core &amp; improvements by 
Evan Wallace, 
Eduard Bespalov, 
Joost Nieuwenhuijse, 
Alexandre Girard
<p>
Licenses: MIT License &amp; GPLv2<br>
Get your copy/clone/fork from <a href="https://github.com/Spiritdude/OpenJSCAD.org" target=_blank>GitHub: OpenJSCAD</a>
<p><br>
<a class=okButton href='#' onclick="$('#about').hide(); return false;"> OK </a>
</div>

<div id="editor"  style="display:none">// -- OpenJSCAD.org logo

function main() {
   return union(
      difference(
         cube({size: 3, center: true}),
         sphere({r:2, center: true})
      ),
      intersection(
          sphere({r: 1.3, center: true}),
          cube({size: 2.1, center: true})
      )
   ).translate([0,0,1.5]).scale(10);
}
</div>

<script>
var ex = [ 
{ file:'logo.jscad', title: 'OpenJSCAD.org Logo' },
{ file:'logo.amf', title: 'OpenJSCAD.org Logo', type: 'AMF', new: true },

{ file:'example001.jscad', title: 'Sphere with cutouts', spacing: true },
{ file:'example001.scad', title: 'Sphere with cutouts', type: 'OpenSCAD' },
{ file:'example002.jscad', title: 'Cone with cutouts' },
{ file:'example002.scad', title: 'Cone with cutouts', type: 'OpenSCAD' },
{ file:'example003.jscad', title: 'Cube with cutouts' },
{ file:'example003.scad', title: 'Cube with cutouts', type: 'OpenSCAD' },
// { file:'example004.jscad', title: 'Cube minus sphere' },
{ file:'example005.jscad', title: 'Pavillon' },
// { file:'center.jscad', title: 'Centers of Primitives' },

// { file:'bunch-cubes.jscad', title: 'Bunch of Cubes', new: true }, 
{ file:'lookup.jscad', title: 'Lookup()', spacing: true },
{ file:'expand.jscad', title: 'Expand()' },
{ file:'rectangular_extrude.jscad', title: 'Rectangular_extrude()' },
{ file:'linear_extrude.jscad', title: 'Linear_extrude()' },
{ file:'rotate_extrude.jscad', title: 'Rotate_extrude()' },
{ file:'polyhedron.jscad', title: 'Polyhedron()' },
{ file:'hull.jscad', title: 'Hull()', new: true },
{ file:'chain_hull.jscad', title: 'Chain_hull()', new: true },
{ file:'torus.jscad', title: 'Torus()' },

{ file:'text.jscad', title: 'Vector_text()', new: true, spacing: true },

{ file:'transparency.jscad', title: 'Transparency', new: true, spacing: true },
{ file:'transparency.amf', title: 'Transparency', type: 'AMF', new: true },
{ file:'transparency2.jscad', title: 'Transparency 2', new: true },

{ file:'slices/double-screw.jscad', title: 'SolidFromSlices(): Double Screw', new: true, spacing: true },
{ file:'slices/four2three.jscad', title: 'SolidFromSlices(): 4 to 3', new: true },
{ file:'slices/four2three-round.jscad', title: 'SolidFromSlices(): 4 to 3 round', new: true },
{ file:'slices/spring.jscad', title: 'SolidFromSlices(): Spring', new: true },
{ file:'slices/tor.jscad', title: 'SolidFromSlices(): Tor (multi-color)', new: true },
{ file:'slices/rose.jscad', title: 'SolidFromSlices(): Rose Curve', new: true },

{ file:'servo.jscad', title: 'Interactive Params: Servo Motor', wrap: true },
{ file:'gear.jscad', title: 'Interactive Params: Gear' },
{ file:'s-hook.jscad', title: 'Interactive Params: S Hook' },
{ file:'grille.jscad', title: 'Interactive Params: Grille' },
{ file:'axis-coupler.jscad', title: 'Interactive Params: Axis Coupler' },
{ file:'lamp-shade.jscad', title: 'Interactive Params: Lamp Shade' },
{ file:'celtic-knot-ring.jscad', title: 'Interactive Params: Celtic Knot Ring' },
{ file:'stepper-motor.jscad', title: 'Interactive Params: Stepper Motor' },
{ file:'iphone4-case.jscad', title: 'Interactive Params: iPhone4 Case' },
{ file:'name_plate.jscad', title: 'Interactive Params: Name Plate', new: true },
{ file:'globe.jscad', title: 'Globe', new: true },

{ file:'platonics/', title: 'Recursive Include(): Platonics', new: true, spacing: true },

{ file:'3d_sculpture-VernonBussler.stl', title: '3D Model: 3D Sculpture (Vernon Bussler)', type: 'STL', spacing: true },
{ file:'frog-OwenCollins.stl', title: '3D Model: Frog (Owen Collins)', type: 'STL' },  
{ file:'thing_7-Zomboe.stl', title: '3D Model: Thing 7 / Flower (Zomboe)', type: 'STL' },  
// { file:'organic_flower-Bogoboy23.stl', title: '3D Model: Organic Flower (Bogoboy23)', type: 'STL' }, // all wrong normals!!
{ file:'yoda-RichRap.stl', title: '3D Model: Yoda (RichRap)', type: 'STL' },
// { url:'http://pastebin.com/raw.php?i=wJLctyAQ', title: 'OpenJSCAD.org Logo', type:'Remote JSCAD' }
// { file:'treefrog-Jerrill.stl', title: '3D Model: Treefrog (Jerrill)', type: 'STL' },    // nice frog, yet slow 
// { file:'klein_bottle-DizingOf.stl', title: '3D Model: Klein Bottle (DizingOf)', type: 'STL' } // too slow, over 400k triangles, huge memory consumption
];
if(me=='web-online') {
   var wrap = 26;
   var colp = 100/Math.floor(ex.length/wrap+1)+"%";
   var src = '<table width=100%><tr><td widthx="+colp+" valign=top>';
   //src += "<img id=examplesHandle src=\"imgs/menuHandleHU.png\">";
   //src += '<b>Examples:</b>';
   for(var i=0; i<ex.length; i++) {
      if(ex[i].wrap) {
         src += "</td><td class=examplesSeparator widthx="+colp+" valign=top>";
      }
      if(ex[i].spacing) src += "<p/>";
      src += "<li><a href=# onclick='fetchExample(\"examples/"+ex[i].file+"\"); return false;'>"+ex[i].title+"</a>\n";
      if(ex[i].type) src += " <span class=type>("+ex[i].type+")</span></a>";
      if(ex[i].new) src += " <span class=newExample>new</span></a>";
      //src += "<li><a href='examples/"+ex[i].file+"\'>"+ex[i].title+"</a>\n";
   }
   src += "</td></tr></table>";
   $('#examples').html(src);
} else {
   // examples off-line won't work yet as XHR is used
   $('#examples').html("You are offline, drag'n'drop the examples from your installation");
}

{
   var options = [ 'renderCode', 'author', 'license' ];
   var metakeys = [ 'author', 'license' ];
   saveOptions = function() {
      for(var k in options) {
         k = options[k];
         //echo("setting "+k);
         setCookie(k,$('#'+k).val());
         if(metakeys[k]) metadata[k] = options[k];
      }
   }
   getOptions = function() {
      for(var k in options) {
         k = options[k];
         //echo("getting "+k);
         if(getCookie(k)) $('#'+k).val(getCookie(k))
      }
   }
   
   var src = '';
   src += "<form id=optionsForm onsubmit='saveOptions(); return false'>";
   src += "<div class=optionGroup><b>Your Identity / Full Name & Email</b><br/>";
   src += "<input id=author type=text name=author size=30><div class=optionInfo>Applies when you export AMF (sets metadata)</div></div>";

   var licenseOptions = {
      "Public Domain": "Public Domain", 
      "CC BY": "Creative Commons CC BY", 
      "CC BY-ND": "Creative Commons CC BY-ND", 
      "CC BY-NC": "Creative Commons CC BY-NC", 
      "CC BY-SA": "Creative Commons CC BY-SA", 
      "CC BY-NC-SA": "Creative Commons CC BY-NC-SA", 
      "CC BY-NC-ND": "Creative Commons CC BY-NC-ND", 
      "MIT": "MIT License", 
      "GPLv2": "GPLv2", 
      "GPLv3": "GPLv3", 
      "Copyright": "Copyright",
   };
   src += "<div class=optionGroup><b>Default License</b><br/>";
   src += "<select id=license name=license>";
   for(var k in licenseOptions) {
      src += "<option value='"+k+"'>"+licenseOptions[k];
      src += "<br/>";
   }
   src += "</select><div class=optionInfo>Applies when you export AMF (sets metadata)</div></div>\n";

   if(0) {
      var renderCodeOptions = {
         shiftReturn: "SHIFT+RETURN", 
         auto: "Automatic"
      };
      src += "<div class=optionGroup><b>Render Code</b></br>";
      src += "<select id=renderCode name=renderCode>";
      for(var k in renderCodeOptions) {
         src += "<option value='"+k+"'>"+renderCodeOptions[k];
      }
      src += "</select></div>";
   }
   if(1) {
      var plateOptions = {
         "200x200": "200mm x 200mm",
         "150x150": "150mm x 150mm",
         "100x100": "100mm x 100mm",
         "custom": "Custom",
         "none": "None",
      };
      src += "<div class=optionGroup><b>Plate</b></br>";
      src += "<select id=plate name=plate>";
      for(var k in plateOptions) {
         src += "<option value='"+k+"'>"+plateOptions[k];
      }
      src += "</select><br/>";
      src += "<div style='display: none' id=customPlate>Custom: <input type=text id=plateCustomX name=plateCustomX size=4 value='125'> x <input type=text id=plateCustomY name=plateCustomY size=4 value='125'> [mm]</div>";
      src += "</div>";
      
   }
   if(1) {
      var themeOptions = {
         "bright": "Bright",
         "dark": "Dark",
      };
      src += "<div class=optionGroup><b>Theme</b></br>";
      src += "<select id=theme name=theme>";
      for(var k in themeOptions) {
         src += "<option value='"+k+"'>"+themeOptions[k];
      }
      src += "</select><br/>";
      src += "</div>";
   }
   
   src += "</form>";
   $('#options').html(src);
}
</script>

<div oncontextmenu="return false;" id="viewer"></div> <!-- avoiding popup when right mouse is clicked -->

<div id="parametersdiv"></div>
<div id="tail">
<div id="statusdiv"></div>
<div id="filedropzone" style="display:none">
  <div id="filedropzone_empty">
  <script>document.write("Drop your jscad, scad, amf, stl file or multiple jscad files "+
     (browser=='chrome'&&me=='web-online'?"or folder with jscad files ":"")+
     " here (see <a style='font-weight: normal' href='https://github.com/Spiritdude/OpenJSCAD.org/wiki/User-Guide#support-of-include' target=_blank>details</a>) "+
     "<br>or edit OpenJSCAD or OpenSCAD source-code in built-in editor direct.");
  </script></div>
  <div id="filedropzone_filled">
    <span id="currentfile">...</span>
    <div id="filebuttons">
      <button id="getstlbutton" style="display:none" onclick="getStl();">Get STL</button>
      <button onclick="superviseAllFiles({forceReload:true});">Reload</button>
      <!--button onclick="parseFile(gCurrentFile,true,false);">Debug (see below)</button-->
	   <label for="autoreload">Auto Reload</label><input type="checkbox" name="autoreload" value="" id="autoreload" onclick="toggleAutoReload();">
    </div>
  </div>
</div>
</div>
<div id=footer>
OpenJSCAD.org 
<script>document.write(version);</script>, MIT License &amp; GPLv2, get your own copy/clone/fork from <a target=_blank href="https://github.com/Spiritdude/OpenJSCAD.org">GitHub: OpenJSCAD</a>
</div>

<!--script src="http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script-->
<script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>

<script id=conversionWorker type="javascript/worker">
// adapted from http://www.html5rocks.com/en/tutorials/workers/basics/

self.onmessage = function(e) {      // Worker to import STL/OBJ as it can take quite some while for 1MB+ large STLs
   var data = e.data; // JSON.parse(e.data);
   me = data.me;                    // required for openscad.js parse*() 
   version = data.version;          //     ''               ''

   if(data.url) {     // RANT: why do something simple, when it can be done complicate: Workers & importScripts() (guys!!)
      var url = data.url;
      url = url.replace(/#.*$/,'');    // -- just to be sure ...
      url = url.replace(/\?.*$/,'');
      var index = url.indexOf('index.html');
      if(index!=-1) {
         url = url.substring(0,index);
      }
      importScripts(url+'csg.js',url+'openjscad.js',url+'openscad.js');
      var src, type;
      data.filename.match(/\.(stl|obj|amf|gcode)$/i);
      type = RegExp.$1;
      if(type=='obj') {
         src = parseOBJ(data.source,data.filename);
      } else if(type=='amf') {
         src = parseAMF(data.source,data.filename);
      } else if(type=='gcode') {
         src = parseGCode(data.source,data.filename);
      } else {
         src = parseSTL(data.source,data.filename);
      }
      self.postMessage({ source: src, filename: data.filename, url: data.remote });
   }
};
</script>

<script>
var gCurrentFile = null;
var gProcessor = null;
var editor = null;

var gCurrentFiles = [];       // linear array, contains files (to read)
var gMemFs = [];              // associated array, contains file content in source gMemFs[i].{name,source}
var gMemFsCount = 0;          // async reading: count of already read files
var gMemFsTotal = 0;          // async reading: total files to read (Count==Total => all files read)
var gMemFsChanged = 0;        // how many files have changed
var gRootFs = [];             // root(s) of folders 

var _includePath = './';

function onload() {
   // -- http://ace.ajax.org/#nav=howto
/*
   editor = ace.edit("editor");
   editor.setTheme("ace/theme/chrome");
   //document.getElementById('ace_gutter').style.background = 'none';
   editor.getSession().setMode("ace/mode/javascript");
   editor.getSession().on('change', function(e) {
      ;
   });               
   ['Shift-Return'].forEach(function(key) {
      editor.commands.addCommand({
         name: 'myCommand',
         bindKey: { win: key, mac: key },
         exec: function(editor) {
            var src = editor.getValue();
            if(src.match(/^\/\/\!OpenSCAD/i)) {
               editor.getSession().setMode("ace/mode/scad");
               src = openscadOpenJscadParser.parse(src);
            } else {
               editor.getSession().setMode("ace/mode/javascript");
            }
            gMemFs = [];
            gProcessor.setJsCad(src);
         },
      });
   });
   if(0) {     // for reload when drag'n'dropped file(s) ([Reload] equivalent)
      viewer.onkeypress = function(evt) {
         if(evt.shiftKey&&evt.keyCode=='13') {   // Shift + Return
            superviseFiles({forceReload:true});
         }
      };
   }
   
   gProcessor = new OpenJsCad.Processor(document.getElementById("viewer"));
   setupDragDrop();
   //gProcessor.setDebugging(debugging); 
   if(me=='web-online') {    // we are online, fetch first example
      //    gProcessor.setJsCad(editor.getValue());

      if(document.URL.match(/#(http:\/\/\S+)$/)||
         document.URL.match(/#(https:\/\/\S+)$/)) {   // remote file referenced, e.g. http://openjscad.org/#http://somewhere/something.ext
         var u = RegExp.$1;
         var xhr = new XMLHttpRequest();
         //echo("fetching",u);
         xhr.open("GET",'./remote.pl?url='+u,true);
         if(u.match(/\.(stl|gcode)$/i)) {
            xhr.overrideMimeType("text/plain; charset=x-user-defined");    // our pseudo binary retrieval (works with Chrome)
         }
         status("Fetching "+u+" <img id=busy src='imgs/busy.gif'>");
         xhr.onload = function() {
            //echo(this.responseText);
            var data = JSON.parse(this.responseText);
            //echo(data.url,data.filename,data.file);
            fetchExample(data.file,data.url);
            document.location = document.URL.replace(/#.*$/,'#');       // this won't reload the entire web-page
         }
         xhr.send(); 
 
      } else if(document.URL.match(/#(examples\/\S+)$/)) {    // local example, e.g. http://openjscad.org/#examples/example001.jscad
         var fn = RegExp.$1;
         fetchExample(fn);
         document.location = document.URL.replace(/#.*$/,'#');
         
      } else {
         fetchExample('examples/'+ex[0].file);
      }
   } else {
      gProcessor.setJsCad(editor.getValue());
   }
*/
    
   gProcessor = new OpenJsCad.Processor(document.getElementById("viewer"));
   updateSolid();
  // a box is big, zoom out by default
  gProcessor.viewer.setZoom(gProcessor.viewer.getZoom()*3);
}

function updateSolid() {
  gProcessor.setJsCad(document.getElementById('inputJsCad').value);
}

function fetchExample(fn,url) {
   gMemFs = []; gCurrentFiles = [];
   
   $('#editor').show();
   
   if(fn.match(/\.[^\/]+$/)) {     // -- has extension
      ;                                  // -- we could already check if valid extension (later)
   } else {                              // -- folder referenced
      if(!fn.match(/\/$/)) 
         fn += "/";      // add tailing /
      fn += 'main.jscad';
   }

   //echo("checking gMemFs");
   //if(gMemFs[fn]) {
   //   console.log("found locally:",gMemFs[i].name);
   //}
   if(1) {     // doesn't work off-line yet
      var xhr = new XMLHttpRequest();
      xhr.open("GET", fn, true);
      if(fn.match(/\.(stl|gcode)$/i)) {
         xhr.overrideMimeType("text/plain; charset=x-user-defined");    // our pseudo binary retrieval (works with Chrome)
      }
      status("Loading "+fn+" <img id=busy src='imgs/busy.gif'>");
      xhr.onload = function() {
         var source = this.responseText;
         var editorSource = source;
         var asyncComputation = false;
         var path = fn;

         _includePath = path.replace(/\/[^\/]+$/,'/');
         
         editor.getSession().setMode("ace/mode/javascript");
         if(fn.match(/\.jscad$/i)||fn.match(/\.js$/i)) {
            status("Processing "+fn+" <img id=busy src='imgs/busy.gif'>");
            //if(url) editorSource = "// Remote retrieved <"+url+">\n"+editorSource;
            putSourceInEditor(editorSource,fn);
            gProcessor.setJsCad(source,fn);
            
         } else if(fn.match(/\.scad$/i)) {
            status("Converting "+fn+" <img id=busy src='imgs/busy.gif'>");
            editorSource = source;
            //if(url) editorSource = "// Remote retrieved <"+url+">\n"+editorSource;
            if(!editorSource.match(/^\/\/!OpenSCAD/i)) {
               editorSource = "//!OpenSCAD\n"+editorSource;
            }
            source = openscadOpenJscadParser.parse(editorSource);
            if(0) {
               source = "// OpenJSCAD.org: scad importer (openscad-openjscad-translator) '"+fn+"'\n\n"+source;
            }
            editor.getSession().setMode("ace/mode/scad");
            putSourceInEditor(editorSource,fn);
            gProcessor.setJsCad(source,fn);
            
         } else if(fn.match(/\.(stl|obj|amf|gcode)$/i)) {
            status("Converting "+fn+" <img id=busy src='imgs/busy.gif'>");
            if(!fn.match(/\.amf/)) {
               // import STL/OBJ/AMF via Worker() (async computation) as it takes quite some time
               // RANT: the whole Blob() & Worker() is anything but a clean concept, mess over mess:
               //       for example, to pass a DOM variable to worker via postMessage may create a circular reference
               //       as the data is serialized, e.g. you cannot pass document and in the Worker access document.window.
               //       Dear Google / JavaScript developers: don't make JS unuseable with this mess!
               var blobURL = new Blob([document.querySelector('#conversionWorker').textContent]);
               // -- the messy part coming here:
               //var url = window.URL; url = url.replace(/#.*$/,''); url = url.createObjectURL(blobURL);
               var worker = new Worker(window.webkitURL!==undefined?window.webkitURL.createObjectURL(blobURL):window.URL.createObjectURL(blobURL));
               //var worker = new Worker(window.URL.createObjectURL(blobURL));
               worker.onmessage = function(e) {    // worker finished
                  var data = e.data;
                  //echo("worker end:",data.source,data.filename);
                  if(e.url) data.source = "// Remote retrieve <"+e.url+">\n"+data.source;
                  putSourceInEditor(data.source,data.filename);
                  gProcessor.setJsCad(data.source,data.filename);
               };
               var u = document.location.href;
               u = u.replace(/#.*$/,'');
               u = u.replace(/\?.*$/,'');
               worker.postMessage({me: me, version: version, url: u, remote: url, source: source, filename: fn }); // start worker
               asyncComputation = true;

            } else {       // async (disabled)
               status("Converting "+fn+" <img id=busy src='imgs/busy.gif'>");
               fn.match(/\.(stl|obj|amf|gcode)$/i);
               var type = RegExp.$1;
               if(type=='obj') {
                  editorSource = source = parseOBJ(source,fn);   
               } else if(type=='amf') {
                  editorSource = source = parseAMF(source,fn);   
               } else if(type=='gcode') {
                  editorSource = source = parseGCode(source,fn);   
               } else {
                  editorSource = source = parseSTL(source,fn);   
               }
               //if(url) editorSource = source = "// Remote retrieved <"+url+">\n"+editorSource;
               putSourceInEditor(source,fn);
            }
            if(!asyncComputation) {
               gProcessor.setJsCad(source,fn);
            }
         }
      }
      xhr.send();
   }
}

function putSourceInEditor(src,fn) {
   editor.setValue(src); 
   editor.clearSelection();
   editor.navigateFileStart();

   previousFilename = fn;
   previousScript = src;
   gPreviousModificationTime = "";
}

// -----------------------------------------------------------------------------------------------------------
// Drag'n'Drop Functionality
// from old OpenJsCad processfile.html by Joost Nieuwenhuijse, 
//     with changes by Rene K. Mueller
// History:
// 2013/04/02: massively upgraded to support multiple-files (chrome & firefox) and entire directory drag'n'drop (chrome only)

// Show all exceptions to the user:
OpenJsCad.AlertUserOfUncaughtExceptions();

function setupDragDrop() {
  // Check for the various File API support.
  if (window.File && window.FileReader && window.FileList) {
    // Great success! All the File APIs are supported.
  } else {
    throw new Error("Error: Your browser does not fully support the HTML File API");
  }
  var dropZone = document.getElementById('filedropzone');
  //var dropZone = document.getElementById('viewer');
  dropZone.addEventListener('dragover', function(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    evt.dataTransfer.dropEffect = 'copy';
  }, false);
  dropZone.addEventListener('drop', handleFileSelect, false);
}

function handleFileSelect(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  gMemFs = []; gMainFile = null;
  if(!evt.dataTransfer) throw new Error("Not a datatransfer (1)");
  if(!evt.dataTransfer.files) throw new Error("Not a datatransfer (2)");

  if(evt.dataTransfer.items&&evt.dataTransfer.items.length) {     // full directories, let's try
    var items = evt.dataTransfer.items;
    gCurrentFiles = [];
    gMemFsCount = 0;
    gMemFsTotal = 0;
    gMemFsChanged = 0;
    gRootFs = [];
    for(var i=0; i<items.length; i++) {
       //var item = items[i];//.webkitGetAsEntry();
       //walkFileTree({file:items[i]});
       walkFileTree(items[i].webkitGetAsEntry());
       gRootFs.push(items[i].webkitGetAsEntry());
    }
  }
  if(browser=='firefox'||me=='web-offline') {     // -- fallback, walkFileTree won't work with file://
     if(evt.dataTransfer.files.length>0) {
       gCurrentFiles = [];                              // -- be aware: gCurrentFiles = evt.dataTransfer.files won't work, as rewriting file will mess up the array
       for(var i=0; i<evt.dataTransfer.files.length; i++) {
         gCurrentFiles.push(evt.dataTransfer.files[i]);  // -- need to transfer the single elements
       }
       loadLocalFiles();
     } else {
       throw new Error("Please drop a single jscad, scad, stl file, or multiple jscad files");
     }
  }
}

function walkFileTree(item,path) {              // this is the core of the drag'n'drop:
                                                //    1) walk the tree
                                                //    2) read the files (readFileAsync)
                                                //    3) re-render if there was a change (via readFileAsync)
   path = path||"";
   //console.log("item=",item);
   if(item.isFile) {
      item.file(function(file) {                // this is also asynchronous ... (making everything complicate)
         if(file.name.match(/\.(jscad|js|scad|obj|stl|amf|gcode)$/)) {   // for now all files OpenJSCAD can handle
            console.log("walkFileTree File: "+path+item.name);
            gMemFsTotal++;
            gCurrentFiles.push(file);
            readFileAsync(file);
         }
      });

   } else if(item.isDirectory) {
      var dirReader = item.createReader();
      console.log("walkFileTree Folder: "+item.name);
      dirReader.readEntries(function(entries) {
        // console.log("===",entries,entries.length);
         for(var i=0; i<entries.length; i++) {
            //console.log(i,entries[i]);
            //walkFileTree({item:entries[i], path: path+item.name+"/"});
            walkFileTree(entries[i],path+item.name+"/");
         }
      });
   }
}

function loadLocalFiles() {               // this is the linear drag'n'drop, a list of files to read (when folders aren't supported)
  var items = gCurrentFiles;
  console.log("loadLocalFiles",items);
  gMemFsCount = 0;
  gMemFsTotal = items.length;      
  gMemFsChanged = 0;
  
  for(var i=0; i<items.length; i++) {
     var f = items[i];
     console.log(f);
     readFileAsync(f);
     //gMemFs[f.name] = f;
  }
}

function setCurrentFile(file) {              // set one file (the one dragged) or main.jscad
  gCurrentFile = file;
  gPreviousModificationTime = "";

  console.log("execute: "+file.name);
  if(file.name.match(/\.(jscad|js|scad|stl|obj|amf|gcode)$/i)) {
    gCurrentFile.lang = RegExp.$1;
  } else {
    throw new Error("Please drop a file with .jscad, .scad or .stl extension");
  }
  if(file.size == 0) {
    throw new Error("You have dropped an empty file");
  }              
  fileChanged(file);
}     

function readFileAsync(f) {                // RANT: JavaScript at its finest: 50 lines code to read a SINGLE file 
  var reader = new FileReader();           //       this code looks complicate and it is complicate.

  console.log("request: "+f.name+" ("+f.fullPath+")");
  reader.onloadend = function(evt) {
     if(evt.target.readyState == FileReader.DONE) {
        var source = evt.target.result;

        console.log("done reading: "+f.name,source?source.length:0);   // it could have been vanished while fetching (race condition)
        gMemFsCount++;
        
        if(!gMemFs[f.name]||gMemFs[f.name].source!=source)     // note: assigning f.source = source too make gMemFs[].source the same, therefore as next
          gMemFsChanged++;

        f.source = source;                 // -- do it after comparing
         
        gMemFs[f.name] = f;                // -- we cache the file (and its actual content)

        if(gMemFsCount==gMemFsTotal) {                // -- are we done reading all?
           console.log("all "+gMemFsTotal+" files read.");
           if(gMemFsTotal>1||gMemFsCount>1) {         // we deal with multiple files, so we hide the editor to avoid confusion
             $('#editor').hide();
           } else {
             $('#editor').show();
           }
           
           if(gMemFsTotal>1) {
              if(gMemFs['main.jscad']) {
                 gMainFile = gMemFs['main.jscad'];
              } else if(gMemFs['main.js']) {
                 gMainFile = gMemFs['main.js'];
              } else {
                 for(var fn in gMemFs) {
                   if(gMemFs[fn].name.match(/\/main.jscad$/)||gMemFs[fn].name.match(/\/main.js$/)) {
                      gMainFile = gMemFs[fn];
                   }
                 }
              }
           } else {
             gMainFile = f;  
           }
           if(gMemFsChanged>0) {
              if(!gMainFile)
                throw("No main.jscad found");
              console.log("update & redraw "+gMainFile.name);
              setCurrentFile(gMainFile);
           }
        }
     
     } else {
        throw new Error("Failed to read file");
        if(gProcessor) gProcessor.clearViewer();
		  previousScript = null;
     }
  };
  if(f.name.match(/\.(stl|gcode)$/)) {
     reader.readAsBinaryString(f,"UTF-8");
  } else {
     reader.readAsText(f,"UTF-8");
  }
}

function fileChanged(f) {               // update the dropzone visual & call the main parser
  var dropZone = document.getElementById('filedropzone');
  gCurrentFile = f;
  if(gCurrentFile) {
    var txt;
    if(gMemFsTotal>1) {
       txt = "Current file: "+gCurrentFile.name+" (+ "+(gMemFsTotal-1)+" more files)";
    } else {
       txt = "Current file: "+gCurrentFile.name;
    }
    document.getElementById("currentfile").innerHTML = txt;
    document.getElementById("filedropzone_filled").style.display = "block";
    document.getElementById("filedropzone_empty").style.display = "none";
  } else {
    document.getElementById("filedropzone_filled").style.display = "none";
    document.getElementById("filedropzone_empty").style.display = "block";
  }
  parseFile(f,false,false);
}

function superviseAllFiles(p) {           // check if there were changes: (re-)load all files and check if content was changed
   //var f = gMainFile;                   // note: main functionality lies in readFileAsync()
   console.log("superviseAllFiles()");
   
   gMemFsCount = gMemFsTotal = 0;
   gMemFsChanged = 0;
   
   if(p&&p.forceReload) 
      gMemFsChanged++;
   
   if(!gRootFs||gRootFs.length==0||me=='web-offline') {              // walkFileTree won't work with file:// (regardless of chrome|firefox)
     for(var i=0; i<gCurrentFiles.length; i++) {
        console.log("[offline] checking "+gCurrentFiles[i].name);
        gMemFsTotal++;
        readFileAsync(gCurrentFiles[i]);
      }
   } else {
      for(var i=0; i<gRootFs.length; i++) {
         walkFileTree(gRootFs[i]);
      }
   }
}

var autoReloadTimer = null;

function toggleAutoReload() {
	if (document.getElementById("autoreload").checked) {
		autoReloadTimer = setInterval(function(){
		  //parseFile(gCurrentFile,false,true);
		  superviseAllFiles();
    }, 1000);
	} else {
		if (autoReloadTimer !== null) {
			clearInterval(autoReloadTimer);
			autoReloadTimer = null;
		}
	}
}

var previousScript = null;

function parseFile(f, debugging, onlyifchanged) {     // here we convert the file to a renderable source (jscad)
  if(arguments.length==2) {
    debugging = arguments[1];
    onlyifchanged = arguments[2];
    f = gCurrentFile;
  }
  //gCurrentFile = f;
  var source = f.source;
  var editorSource = source;
  if(source == "") {
    if(document.location.toString().match(/^file\:\//i)) {
      throw new Error("Could not read file. You are using a local copy of OpenJSCAD.org; if you are using Chrome, you need to launch it with the following command line option:\n\n--allow-file-access-from-files\n\notherwise the browser will not have access to uploaded files due to security restrictions.");
    } else {
      throw new Error("Could not read file.");
    }            
  } else {         
    if(gProcessor && ((!onlyifchanged) || (previousScript !== source))) {
      var fn = gCurrentFile.name;
      fn = fn.replace(/^.*\/([^\/]*)$/,"$1");     // remove path, leave filename itself
      gProcessor.setDebugging(debugging); 
      //echo(gCurrentFile.lang);
      editor.getSession().setMode("ace/mode/javascript");
      var asyncComputation = false;
      
      if(gCurrentFile.lang=='jscad'||gCurrentFile.lang=='js') {
         ; // default
      } else if(gCurrentFile.lang=='scad') {
         editorSource = source;
         if(!editorSource.match(/^\/\/!OpenSCAD/i)) {
            editorSource = "//!OpenSCAD\n"+editorSource;
         }
         source = openscadOpenJscadParser.parse(editorSource);
         if(0) {
            source = "// OpenJSCAD.org: scad importer (openscad-openjscad-translator) '"+fn+"'\n\n"+source;
         }
         editor.getSession().setMode("ace/mode/scad");  
         
      } else if(gCurrentFile.lang.match(/(stl|obj|amf|gcode)/i)) {
         status("Converting "+fn+" <img id=busy src='imgs/busy.gif'>");
         if(!fn.match(/amf/i)) {     // -- if you debug the STL parsing, change it to 'if(0&&...' so echo() works, otherwise in workers
                                     //    echo() is not working.., and parseAMF requires jquery, which seem not working in workers
            var blobURL = new Blob([document.querySelector('#conversionWorker').textContent]);
            // -- the messy part coming here:
            var worker = new Worker(window.webkitURL!==undefined?window.webkitURL.createObjectURL(blobURL):window.URL.createObjectURL(blobURL));
            worker.onmessage = function(e) {
               var data = e.data;
               //echo("finished converting, source:",data.source);
               if(data&&data.source&&data.source.length) {              // end of async conversion
                  putSourceInEditor(data.source,data.filename);
                  gMemFs[data.filename].source = data.source;
                  gProcessor.setJsCad(data.source,data.filename);
               } else {
                  // worker responds gibberish (likely echo(), but format unknown)
                  // echo("STL worker",data);
               }
            };
            var u = document.location.href;
            u = u.replace(/#.*$/,'');
            u = u.replace(/\?.*$/,'');
            worker.postMessage({me: me, version: version, url: u, source: source, filename: fn });
            asyncComputation = true;
         } else {
            fn.match(/\.(stl|obj|amf|gcode)$/i);
            var type = RegExp.$1;
            if(type=='obj') {
               editorSource = source = parseOBJ(source,fn);   
            } else if(type=='amf') {
               editorSource = source = parseAMF(source,fn);   
            } else if(type=='gcode') {
               editorSource = source = parseGCode(source,fn);   
            } else {
               editorSource = source = parseSTL(source,fn);   
            }
         }
      } else {
         throw new Error("Please drop a file with .jscad, .scad or .stl extension");
      }
      if(!asyncComputation) {                   // end of synchronous conversion
         putSourceInEditor(editorSource,fn);
         gMemFs[fn].source = source;
         gProcessor.setJsCad(source,fn);
      }
    }
  }
}

// ---------------------------------------------------------------------------------------------------------

function setCookie(name, value, days) {
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        var expires = "; expires=" + date.toGMTString();
    } else var expires = "";
    document.cookie = escape(name) + "=" + escape(value) + expires + "; path=/";
}

function getCookie(name) {
    var nameEQ = escape(name) + "=";
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0) return unescape(c.substring(nameEQ.length, c.length));
    }
    return null;
}

function deleteCookie(name) {
    createCookie(name, "", -1);
}

</script>

<textarea id="inputJsCad" style="display:none">

// title: Lasercut box
// author: Benny Malengier
// license: MIT License

var lasercut_frame = true; // if true, dxf, if false, stl of box
var on_plate = true;       // if stl, as a 3D box, or on a on_plate
var side_to_show = 0;      // if 0, all sides, otherwise 1-6 as side nr
var openlid = false; // "Create an box with no lid, so open at top")
var width = 100;   //  "Width of the box in mm. Default 100mm")
var height = 100;  //  "Heigth of the box in mm. Default 100mm")
var depth = 50;    //   "Depth of the box in mm. Default 50mm")

var mitersize = 10;//   "Size of miter in mm. Default 10mm")

var thick     = 3.0;//  "Thickness of material in mm. Default 3.0")
var kerf      = 0.16;  //"Kerf of laserbeam (width of the cut) in mm."
                       //" See http://blog.ponoko.com/2008/09/11/how-much-material-does-the-laser-burn-away/. "
                       //"Default 0.16mm")
var recthole1 = false; //', help="Add rectangular hole rw,rh in side 1")
var recthole2 = false; //"Add rectangular hole rw,rh in side 2")
var recthole3 = false; //"Add rectangular hole rw,rh in side 3")
var recthole4 = false; //"Add rectangular hole rw,rh in side 4")
var recthole5 = false; //"Add rectangular hole rw,rh in side 5")
var recthole6 = false; //"Add rectangular hole rw,rh in side 6")
var rh2h = [40, 4, 4, 4, 4, 4];
var rh2w = [40, 4, 4, 4, 4, 4];

var nrmiterh = 0;
var nrmiterw = 0;
var nrmited = 0;
var eps = 0.2;
var colr = 0.4;
var colg = 0.4;
var colb = 0.4;
var cola = 0.6;


function getParameterDefinitions()
{
  return [
    {name: 'width', type: 'float', initial: 100, caption: "Breedte doos in mm:", captionEN: "Width of box in mm:"},
    {name: 'height', type: 'float', initial: 100, caption: "Hoogte doos in mm:", captionEN: "Height of box in mm:"},
    {name: 'depth', type: 'float', initial: 50, caption: "Diepte in mm:", captionEN: "Depth in mm:"},
    {name: 'mitersize', type: 'int', initial: 10, caption: "Tanden (tabs) grootte in mm:", captionEN: "Miter (tab) size in mm:"},
    {name: 'thick', type: 'float', initial: 3, caption: "Dikte materiaal:", captionEN: "Thickness of the material:"},
    {name: 'kerf', type: 'float', initial: 0.16, caption: "Breedte laserstraal in mm:", captionEN: "Width of laser beam cut in mm:"},

    {
      name: 'type',
      type: 'choice',
      values: ["ASSEMBLED", "LASER", "3D"], 
      captions: ["Geassembleerd", "Lasercut plaat (DXF output)", "3D print plaat (STL output)"], 
      captionsEN: ["Assembled", "Lasercut plate (DXF output)", "3D print plate (STL output)"], 
      caption: 'Layout:',     // optional
      initial: "ASSEMBLED"  // optional, default selected value, first item if omitted
    },
    {
      name: 'openlid',
      type: 'choice',
      values: ["CLOSED", "OPEN"],
      captions: ["Gesloten", "Geen Deksel"],
      captionsEN: ["Closed", "Open Lid"],
      caption: 'Deksel:',
      captionEN: 'Lid:',
      initial: "DRAFT"
    },
    {
      name: 'side',
      type: 'choice',
      values: ["ALL", "BOTTOM", "TOP", "LEFT", "RIGHT", "FRONT", "BACK"],
      captions: ["Alle Zijden", "Bodem", "Top", "Links", "Rechts", "Voor", "Achter"],
      captionsEN: ["All Sides", "Bottom", "Top", "Left", "Right", "Front", "Back"],
      caption: 'Toon:',
      captionEN: 'Show:',
      initial: "ALL"
    },
    {name: 'hw1', type: 'float', initial: 0, caption: "Gat bodem breedte", captionEN: "Hole bottom width:"},
    {name: 'hh1', type: 'float', initial: 0, caption: "Gat bodem hoogte", captionEN: "Hole bottom height:"},
    {name: 'hw4', type: 'float', initial: 0, caption: "Gat top breedte", captionEN: "Hole top width:"},
    {name: 'hh4', type: 'float', initial: 0, caption: "Gat top hoogte", captionEN: "Hole top height:"},
    {name: 'hw2', type: 'float', initial: 0, caption: "Gat links breedte", captionEN: "Hole left width:"},
    {name: 'hh2', type: 'float', initial: 0, caption: "Gat links hoogte", captionEN: "Hole left height:"},
    {name: 'hw3', type: 'float', initial: 0, caption: "Gat voor breedte", captionEN: "Hole front width:"},
    {name: 'hh3', type: 'float', initial: 0, caption: "Gat voor hoogte", captionEN: "Hole front height:"},

  ];
}




function main(params)
{
    // investigate params
    if (params.side == "ALL") side_to_show = 0;
    if (params.side == "BOTTOM") side_to_show = 1;
    if (params.side == "TOP") side_to_show = 4;
    if (params.side == "LEFT") side_to_show = 2;
    if (params.side == "RIGHT") side_to_show = 5;
    if (params.side == "FRONT") side_to_show = 3;
    if (params.side == "BACK") side_to_show = 6;
    
    if (params.hw1 != 0 &amp;&amp; params.hh1 != 0) {
        recthole1 = true;
        rh2w[0] = params.hw1; 
        rh2h[0] = params.hh1; 
    }
    if (params.hw2 != 0 &amp;&amp; params.hh2 != 0) {
        recthole2 = true;
        rh2w[1] = params.hw2; 
        rh2h[1] = params.hh2; 
    }
    if (params.hw3 != 0 &amp;&amp; params.hh3 != 0) {
        recthole3 = true;
        rh2w[2] = params.hw3; 
        rh2h[2] = params.hh3; 
    }
    if (params.hw4 != 0 &amp;&amp; params.hh4 != 0) {
        recthole4 = true;
        rh2w[3] = params.hw4; 
        rh2h[3] = params.hh4; 
    }
    
    width = params.width;
    height = params.height;
    depth = params.depth;
    mitersize = params.mitersize;
    thick = params.thick;
    kerf = params.kerf;
    
    if (params.type == "ASSEMBLED") {
        lasercut_frame = false;
        on_plate = false;
    } else if (params.type == "LASER") {
        lasercut_frame = true;
        on_plate = true;
    } else { //3D
        lasercut_frame = false;
        on_plate = true;
    }
    
    if (params.openlid == "CLOSED") openlid = false;
    if (params.openlid == "OPEN") openlid = true;
    
    // start construction
    var sidenr = 0;
    var startx = 5+width/2 - 100;
    var starty = 5+height/2 - 100;
    if (! on_plate) {
        startx = 0;
        starty = 0;
    }
    var holepoints;
    checkinput();
    var polypoints = squareframe(startx, starty, width, height, nrmiterw, nrmiterh,
                       thick, false, false, 0);
    //OpenJsCad.log(polypoints);
    var shape1 = new CSG.Polygon2D( polypoints ).extrude({offset: [0, 0, thick]}).setColor(colr, colg, colb, cola);
    //var shape1 = CAG.fromPoints( polypoints );
    if (recthole1) {
        holepoints = squarehole(startx, starty, width, height, rh2h[sidenr], rh2w[sidenr]);
        OpenJsCad.log(holepoints);
        var hole1 = new CSG.Polygon2D( holepoints );
        hole1 = hole1.extrude({offset: [0,0,thick+eps]}).translate([0,0,-eps/2]);
        shape1 = shape1.subtract(hole1);
    }
    
    sidenr += 1;
    if (openlid)  openlid = 2; //left side
    startx = 5+width+5+depth/2 - 100;
    starty = 5+height/2 - 100;
    if (! on_plate) {
        startx = 0;
        starty = 0;
    }
    polypoints = squareframe(startx, starty, depth, height, nrmiterd, nrmiterh,
                        thick, true, false, openlid);
    var shape2 = new CSG.Polygon2D( polypoints ).extrude({offset: [0, 0, thick]}).setColor(colr, colg, colb, cola);
    if (recthole2) {
        holepoints = squarehole(startx, starty, depth, height, rh2h[sidenr], rh2w[sidenr]);
        var hole2 = new CSG.Polygon2D( holepoints );
        hole2 = hole2.extrude({offset: [0,0,thick+eps]}).translate([0,0,-eps/2]);
        shape2 = shape2.subtract(hole2);
    }
    if (! on_plate) {
        shape2 = shape2.mirroredX().rotateY(90).translate([-width/2 - thick -1, 0, depth/2]);
    }
    
    sidenr += 1;
    if (openlid)  openlid = 3; //front side
    startx = 5+width/2 - 100;
    starty = 5+height+5+depth/2 - 100;
    if (! on_plate) {
        startx = 0;
        starty = 0;
    }
    polypoints = squareframe(startx, starty, width, depth, nrmiterw, nrmiterd,
                       thick, true, true, openlid);
    var shape3 = new CSG.Polygon2D( polypoints ).extrude({offset: [0, 0, thick]}).setColor(colr,colg, colb, cola);
    if (recthole3) {
        holepoints = squarehole(startx, starty, width, depth, rh2h[sidenr], rh2w[sidenr]);
        var hole3 = new CSG.Polygon2D( holepoints );
        hole3 = hole3.extrude({offset: [0,0,thick+eps]}).translate([0,0,-eps/2]);
        shape3 = shape3.subtract(hole3);
    }
    if (! on_plate) {
        shape3 = shape3.rotateX(90).translate([0,-height/2-1,depth/2]);
    }
    
    sidenr += 1;
    if (!openlid) {    // the top lid
        startx = 5+width+5+depth+5+depth+5+width/2 - 100;
        starty = 5+height/2 - 100;
        if (! on_plate) {
            startx = 0;
            starty = 0;
        }
        polypoints = squareframe(startx, starty, width, height, nrmiterw, nrmiterh,
                        thick, false, false, openlid);
        var shape4 = new CSG.Polygon2D( polypoints ).extrude({offset: [0, 0, thick]}).setColor(colr,colg, colb, cola);
        if (recthole4) {
            holepoints = squarehole(startx, starty, width, height, rh2h[sidenr], rh2w[sidenr]);
            var hole4 = new CSG.Polygon2D( holepoints );
            hole4 = hole4.extrude({offset: [0,0,thick+eps]}).translate([0,0,-eps/2]);
            shape4 = shape4.subtract(hole4);
        }
        if (! on_plate) {
            shape4 = shape4.translate([0,0,depth+thick+1]);
        }
    }
    
    sidenr += 1;
    if (openlid)  openlid = 4; //
    startx = 5+width+5+depth+5+depth/2 - 100; 
    starty = 5+height/2 - 100;
    if (! on_plate) {
        startx = 0;
        starty = 0;
    }
    polypoints = squareframe(startx, starty, depth, height, nrmiterd, nrmiterh,
                       thick, true, false, openlid);
    var shape5 = new CSG.Polygon2D( polypoints ).extrude({offset: [0, 0, thick]}).setColor(colr,colg, colb, cola);
    if (recthole5) {
        holepoints = squarehole(startx, starty, depth, height, rh2h[sidenr], rh2w[sidenr]);
        var hole5 = new CSG.Polygon2D( holepoints );
        hole5 = hole5.extrude({offset: [0,0,thick+eps]}).translate([0,0,-eps/2]);
        shape5 = shape5.subtract(hole5);
    }
    if (! on_plate) {
        shape5 = shape5.rotateY(90).translate([+width/2, 0, depth/2]);
    }
    
    sidenr += 1;
    if (openlid)  openlid = 1; //
    startx = 5+width+5+width/2 - 100;
    starty = 5+height+5+depth/2 - 100;
    if (! on_plate) {
        startx = 0;
        starty = 0;
    }
    polypoints = squareframe(startx, starty, width, depth, nrmiterw, nrmiterd,
                       thick, true, true, openlid);
    var shape6 = new CSG.Polygon2D( polypoints ).extrude({offset: [0, 0, thick]}).setColor(colr,colg, colb, cola);
    if (recthole6) {
        holepoints = squarehole(startx, starty, width, depth, rh2h[sidenr], rh2w[sidenr]);
        var hole6 = new CSG.Polygon2D( holepoints );
        hole6 = hole6.extrude({offset: [0,0,thick+eps]}).translate([0,0,-eps/2]);
        shape6 = shape6.subtract(hole6);
    }
    if (! on_plate) {
        shape6 = shape6.mirroredY().rotateX(90).translate([0,+height/2+thick+1,depth/2]);
    }
    
    if (lasercut_frame) {
        //2D projection
        var z0basis = CSG.OrthoNormalBasis.Z0Plane();
        var shape1_2d = shape1.projectToOrthoNormalBasis(z0basis);
        var shape2_2d = shape2.projectToOrthoNormalBasis(z0basis);
        var shape3_2d = shape3.projectToOrthoNormalBasis(z0basis);
        if (!openlid)
            var shape4_2d = shape4.projectToOrthoNormalBasis(z0basis);
        var shape5_2d = shape5.projectToOrthoNormalBasis(z0basis);
        var shape6_2d = shape6.projectToOrthoNormalBasis(z0basis);
        if (side_to_show == 0 &amp;&amp; !openlid) {
            return new CAG().union( [shape1_2d, shape2_2d, shape3_2d, shape4_2d, shape5_2d, shape6_2d]);
        } else if (side_to_show == 0 &amp;&amp; openlid) {
            return new CAG().union([shape1_2d, shape2_2d, shape3_2d, shape5_2d, shape6_2d]);
        } else if (side_to_show == 1) {
            return new CAG().union([shape1_2d]);
        } else if (side_to_show == 2) {
            return new CAG().union([shape2_2d]);
        } else if (side_to_show == 3) {
            return new CAG().union([shape3_2d]);
        } else if (side_to_show == 4 &amp;&amp; !openlid) {
            return new CAG().union([shape4_2d]);
        } else if (side_to_show == 4 &amp;&amp; openlid) {
            throw new Error("ERROR: side 4 does not exist, no lid requested!");
            return [];
        } else if (side_to_show == 5) {
            return new CAG().union([shape5_2d]);
        } else if (side_to_show == 6) {
            return new CAG().union([shape6_2d]);
        } else return [];
    } else {
    
        if (side_to_show == 0 &amp;&amp; !openlid) {
            return [shape1, shape2, shape3, shape4, shape5, shape6];
        } else if (side_to_show == 0 &amp;&amp; openlid) {
            return [shape1, shape2, shape3, shape5, shape6];
        } else if (side_to_show == 1) {
            return [shape1];
        } else if (side_to_show == 2) {
            return [shape2];
        } else if (side_to_show == 3) {
            return [shape3];
        } else if (side_to_show == 4 &amp;&amp; !openlid) {
            return [shape4];
        } else if (side_to_show == 4 &amp;&amp; openlid) {
            throw new Error("ERROR: side 4 does not exist, no lid requested!");
            return [];
        } else if (side_to_show == 5) {
            return [shape5];
        } else if (side_to_show == 6) {
            return [shape6];
        } else return [];
    }
}

function float2int (value) {
    return ~~value;
}

function checkinput()
{
    nrmiterw = float2int(round(width / mitersize ));
    if (nrmiterw % 2 === 0) { nrmiterw += 1; }
    if (width/nrmiterw < 2*thick) {
        nrmiterw -= 2;
    }
    nrmiterh = float2int(round(height / mitersize ));
    if (nrmiterh % 2 === 0) { nrmiterh += 1;}
    if (height/nrmiterh < 2*thick) {
        nrmiterh -= 2;
    }
    nrmiterd = float2int(round(depth / mitersize ));
    if (nrmiterd % 2 === 0) { nrmiterd += 1;}
    if (depth/nrmiterd < 2*thick) {
        nrmiterd -= 2;
    }
    if (nrmiterw < 1 || nrmiterh < 1 || nrmiterd < 1) {
        throw new Error("ERROR: reduce mitersize, corners will break off otherwise!");
    }
    
    OpenJsCad.log("Check OK");
}


//one of 4 sides of a box sde
function side(w,h,corner_sizex,corner_sizey,thick,cut_width, div_x, div_y,
         invertX, invertY, xm, ym, openlid)
{
    var outpx = [];
    var outpy = [];
    if (openlid) {
        miter = 0;
    } else {
        miter = 1;
    }
    var dx = corner_sizex*xm;
    var dy = corner_sizey*ym;
    if (invertX) {dx-=thick*xm;}
    if (invertY) {dy-=thick*ym;}
    half_cut = cut_width/2 * (xm+ym);
    if (invertY &amp;&amp; xm) { 
        half_cut = -half_cut;
    }
    if (invertX &amp;&amp; ym) {
        half_cut = -half_cut;
    }
    d = xm-ym;
    if (invertY &amp;&amp; xm) d = -d;
    if (invertX &amp;&amp; ym) d = -d;
    outpx.push(dx+half_cut*Math.abs(xm));  // += PathMove(dx+half_cut*Math.abs(xm),dy+half_cut*Math.abs(ym))
    outpy.push(dy+half_cut*Math.abs(ym));
    if (miter != 0 ) {
        dy = thick *d *Math.abs(xm) *miter;
        dx = thick *d *Math.abs(ym) *miter;
        outpx.push(dx);  // += PathMove(dx,dy)
        outpy.push(dy);
    }
    d = -d;
    half_cut = -half_cut;

    //All but the center one
    ax = (w-2*corner_sizex) / (2*div_x+1);
    ay = (h-2*corner_sizey) / (2*div_y+1);
    //the center one
    bx = w-2*corner_sizex-ax*(2*div_x);
    by = h-2*corner_sizey-ay*(2*div_y);

    for (i = 0; i < Math.abs(div_x*xm+div_y*ym); i++) {
        dx = ax*xm;
        dy = ay*ym;
        outpx.push(dx+half_cut*Math.abs(xm));  // PathMove(dx+half_cut*Math.abs(xm),dy+half_cut*Math.abs(ym))
        outpy.push(dy+half_cut*Math.abs(ym));
        if (miter != 0 ) {
            dy = thick *d*Math.abs(xm) *miter;
            dx = thick *d*Math.abs(ym) *miter;
            outpx.push(dx);  //PolyPoint(dx,dy)
            outpy.push(dy);
        }
        d = -d;
        half_cut = -half_cut;
    }

    dx = bx*xm;
    dy = by*ym;
    outpx.push(dx+half_cut*Math.abs(xm));  // PathMove(dx+half_cut*Math.abs(xm), dy+half_cut*Math.abs(ym))
    outpy.push(dy+half_cut*Math.abs(ym));
    if (miter != 0 ) {
        dy = thick *d*Math.abs(xm) *miter;
        dx = thick *d*Math.abs(ym) *miter;
        outpx.push(dx);  //PolyPoint(dx,dy)
        outpy.push(dy);
    }
    d = -d;
    half_cut = -half_cut;

    for (i = 0; i < Math.abs(div_x*xm+div_y*ym); i++) {
        dx = ax*xm;
        dy = ay*ym;
        outpx.push(dx+half_cut*Math.abs(xm));  //PolyPoint(dx+half_cut*Math.abs(xm), dy+half_cut*Math.abs(ym)
        outpy.push(dy+half_cut*Math.abs(ym));
        if (miter != 0 ) {
            dy = thick *d*Math.abs(xm) *miter;
            dx = thick *d*Math.abs(ym) *miter;
            outpx.push(dx);  //PathMove(dx,dy)
            outpy.push(dy);
            OpenJsCad.log([dx,dy]);
        }
        d = -d;
        half_cut = -half_cut;
    }

    dx = corner_sizex*xm;
    dy = corner_sizey*ym;
    if (invertX &amp;&amp; xm) dx -= thick * xm;
    if (invertY &amp;&amp; ym) dy -= thick * ym;
    
    OpenJsCad.log([dx,dy]);
    outpx.push(dx);  //PathMove(dx,dy)
    outpy.push(dy);
    return [outpx, outpy];
}


// x,y: origin of start in mm
// w,h: width and height in mm
// nrmiterw/h: number of miter intervals along w and h
// thick: thickness of material
// invert: invert in x or y direction the logic
function squareframe(x, y, w, h, nrmiterw, nrmiterh, thick, invertX, invertY, openlid)
{
    var i;
    var div_x = float2int((nrmiterw-3) / 2.);
    var div_y = float2int((nrmiterh-3) / 2.);
    var corner_sizex = w/nrmiterw;
    var corner_sizey = h/nrmiterh;
    //convert to 1/10th mm 
    //x = 10*x; y=10*y; w=10*w; h=10*h;thick=10*thick;
    //corner_sizex = corner_sizex*10;corner_sizey = corner_sizey*10;
    //cut_width = kerf*10;
    cut_width = kerf;
    x = x-w/2;
    if (invertX) x+=thick;
    y = y-h/2;
    if (invertY) y+=thick;
    //start point
    var xstart = x;
    var ystart = y;
    var nrpoly = 0;
    var polypt = [new CSG.Vector2D( xstart, ystart)];
    //top side
    var sidetop = side(w,h,corner_sizex,corner_sizey,thick,cut_width,
                     div_x,div_y, invertX, invertY, 1, 0, openlid===1);
    //Right Side
    var sideright= side(w,h,corner_sizex,corner_sizey,thick,cut_width,
                     div_x,div_y, invertX, invertY, 0, 1, openlid===2);
    // bottom Side
    var sidebottom = side(w,h,corner_sizex,corner_sizey,thick,cut_width,
                     div_x,div_y, invertX, invertY, -1, 0, openlid===3);
    // Left side
    var sideleft = side(w,h,corner_sizex,corner_sizey,thick,cut_width,
                     div_x,div_y, invertX, invertY, 0, -1, openlid===4);
    // add all in a polygon
    OpenJsCad.log(["top", sidetop[0]]);
    OpenJsCad.log(["top", sidetop[1]]);
    for (i=0; i&lt; sidetop[0].length; i++ ) {
        polypt[nrpoly+1] = new CSG.Vector2D( sidetop[0][i] + polypt[nrpoly].x , sidetop[1][i] + polypt[nrpoly].y );
        nrpoly += 1;
    }
    for (i=0; i&lt;sideright[0].length; i++ ) {
        polypt[nrpoly+1] = new CSG.Vector2D( sideright[0][i] + polypt[nrpoly].x , sideright[1][i] + polypt[nrpoly].y );
        nrpoly += 1;
    }
    for (i=0; i&lt;sidebottom[0].length; i++ ) {
        polypt[nrpoly+1] = new CSG.Vector2D( sidebottom[0][i]+polypt[nrpoly].x ,
                     sidebottom[1][i]+polypt[nrpoly].y  );
        nrpoly += 1;
    } 
    for (i=0; i&lt;sideleft[0].length-1; i++ ) {
        polypt[nrpoly+1] = new CSG.Vector2D( sideleft[0][i]+polypt[nrpoly].x ,
                     sideleft[1][i]+polypt[nrpoly].y  );
        nrpoly += 1;
    } 
    return polypt ;
}


function squarehole(x, y, w, h, w_hole, h_hole)
{
    x = x-w_hole/2;
    y = y-h_hole/2;
    var nrpoly = 0;
    var polypt = [new CSG.Vector2D( x, y)];
    nrpoly += 1;
    polypt[nrpoly] = new CSG.Vector2D(polypt[nrpoly-1].x + w_hole, polypt[nrpoly-1].y);
    OpenJsCad.log(polypt);
    nrpoly += 1;
    polypt[nrpoly] = new CSG.Vector2D(polypt[nrpoly-1].x, polypt[nrpoly-1].y + h_hole);
    nrpoly += 1;
    polypt[nrpoly] = new CSG.Vector2D(polypt[nrpoly-1].x - w_hole, polypt[nrpoly-1].y);
    return polypt;
}
    
    

</textarea>

</body></html> 
